{% extends 'base.html' %}
{% block content %}
<h1>Order #{{ detail.order.id }} - {{ detail.vendor_name }}</h1>
<p class="muted">
  Status: {{ detail.order.status.value }} |
  Reorder Weeks: {{ detail.order.reorder_weeks }} |
  Stock-up Weeks: {{ detail.order.stock_up_weeks }} |
  Lookback Days: {{ detail.order.history_lookback_days }}
</p>
{% if detail.order.pdf_path %}
<p><a href="/management/ordering-tool/orders/{{ detail.order.id }}/pdf" target="_blank" rel="noopener">Download Vendor PDF</a></p>
{% endif %}
<p><strong>Total Ext Cost:</strong> <span id="order-total-ext-cost">$0.00</span></p>
<p><a href="/management/ordering-tool">Back to Ordering Tool</a></p>
<style>
  .order-grid-wrap { overflow-x: auto; max-width: 100%; border: 1px solid #e5e7eb; border-radius: 8px; }
  .order-grid th button { border: 0; background: transparent; font: inherit; cursor: pointer; padding: 0; text-decoration: underline; }
  .order-grid input[type="number"] { width: 72px; }
  .order-grid input[type="number"].store-col-input { width: 36px; }
  .order-grid .qty-col { width: 64px; min-width: 64px; }
  .order-grid .order-qty-col { width: 64px; min-width: 64px; }
  .order-grid .sug-par-col { width: 56px; min-width: 56px; }
  .order-grid .sug-qty-col { width: 56px; min-width: 56px; }
  .order-grid input[type="number"].js-order-qty { width: 56px; }
</style>

{% if query.get('saved') %}
<p class="muted">Draft saved.</p>
{% endif %}
{% if query.get('submitted') %}
<p class="muted">Order submitted and moved to In Transit.</p>
{% endif %}
{% if detail.order.status.value in ['DRAFT', 'IN_TRANSIT'] %}
<form method="post" action="/management/ordering-tool/orders/{{ detail.order.id }}/delete" style="margin-bottom:12px;">
  <input type="hidden" name="csrf_token" value="{{ csrf_token(request) }}" />
  <button type="submit" onclick="return confirm('Discard this order permanently?');">Discard Order</button>
</form>
{% endif %}

<form method="post" action="/management/ordering-tool/orders/{{ detail.order.id }}/save">
  <input type="hidden" name="csrf_token" value="{{ csrf_token(request) }}" />

  <h2>Normal Confidence</h2>
  <div class="order-grid-wrap">
  <table class="order-grid js-sortable">
    <thead>
      <tr>
        <th>Remove</th>
        <th>SKU</th>
        <th><button type="button" class="js-sort" data-key="item_name">Item</button></th>
        <th>Variation</th>
        <th class="qty-col sug-qty-col"><button type="button" class="js-sort" data-key="suggested_qty" data-type="number">Sug. Qty</button></th>
        <th class="order-qty-col">Order Qty</th>
        <th>Cost</th>
        <th>Ext Cost</th>
        <th class="sug-par-col">Sug. Par</th>
        {% for store in detail.store_columns %}
        <th title="{{ store.store_name }}">{{ store.store_label }}</th>
        <th title="{{ store.store_name }} On Hand">{{ store.store_label|lower }}</th>
        {% endfor %}
      </tr>
    </thead>
    <tbody>
      {% for line in detail.normal_lines %}
      <tr data-item_name="{{ line.item_name|lower }}" data-suggested_qty="{{ line.suggested_qty }}" data-line-id="{{ line.id }}" data-unit-cost="{{ line.unit_cost if line.unit_cost is not none else '' }}">
        <td><input type="checkbox" name="remove__{{ line.id }}" value="1" {% if line.removed %}checked{% endif %} /></td>
        <td>{{ line.sku }}</td>
        <td>{{ line.item_name }}</td>
        <td>{{ line.variation_name }}</td>
        <td class="qty-col sug-qty-col">{{ line.suggested_qty }}</td>
        <td class="order-qty-col"><input type="number" value="{{ line.ordered_qty }}" readonly class="js-order-qty" data-line-id="{{ line.id }}" /></td>
        <td>{{ line.cost_per_item_text }}</td>
        <td class="js-ext-cost" data-line-id="{{ line.id }}">{{ line.extended_cost_text }}</td>
        <td class="sug-par-col">{{ line.suggested_par_level if line.suggested_par_level is not none else '-' }}</td>
        {% for split in line.store_allocations %}
        <td>
          <input
            type="number"
            min="0"
            step="1"
            name="alloc__{{ line.id }}__{{ split.store_id }}"
            value="{{ split.allocated_qty }}"
            title="{{ split.store_name }}"
            class="js-alloc store-col-input"
            data-line-id="{{ line.id }}"
          />
        </td>
        <td><input type="number" value="{{ split.on_hand_qty }}" readonly title="{{ split.store_name }} On Hand" class="store-col-input" /></td>
        {% endfor %}
      </tr>
      {% else %}
      <tr><td colspan="{{ 8 + (detail.store_columns|length * 2) }}">No normal-confidence lines.</td></tr>
      {% endfor %}
    </tbody>
  </table>
  </div>

  <h2>Low Confidence (Manual Par Required Before Submit)</h2>
  <div class="order-grid-wrap">
  <table class="order-grid js-sortable">
    <thead>
      <tr>
        <th>Remove</th>
        <th>SKU</th>
        <th><button type="button" class="js-sort" data-key="item_name">Item</button></th>
        <th>Variation</th>
        <th class="qty-col sug-qty-col"><button type="button" class="js-sort" data-key="suggested_qty" data-type="number">Sug. Qty</button></th>
        <th class="order-qty-col">Order Qty</th>
        <th>Cost</th>
        <th>Ext Cost</th>
        <th class="sug-par-col">Sug. Par</th>
        {% for store in detail.store_columns %}
        <th title="{{ store.store_name }}">{{ store.store_label }}</th>
        <th title="{{ store.store_name }} On Hand">{{ store.store_label|lower }}</th>
        {% endfor %}
      </tr>
    </thead>
    <tbody>
      {% for line in detail.low_confidence_lines %}
      <tr style="background:#fff7ed;" data-item_name="{{ line.item_name|lower }}" data-suggested_qty="{{ line.suggested_qty }}" data-line-id="{{ line.id }}" data-unit-cost="{{ line.unit_cost if line.unit_cost is not none else '' }}">
        <td><input type="checkbox" name="remove__{{ line.id }}" value="1" {% if line.removed %}checked{% endif %} /></td>
        <td>{{ line.sku }}</td>
        <td>{{ line.item_name }}</td>
        <td>{{ line.variation_name }}</td>
        <td class="qty-col sug-qty-col">{{ line.suggested_qty }}</td>
        <td class="order-qty-col"><input type="number" value="{{ line.ordered_qty }}" readonly class="js-order-qty" data-line-id="{{ line.id }}" /></td>
        <td>{{ line.cost_per_item_text }}</td>
        <td class="js-ext-cost" data-line-id="{{ line.id }}">{{ line.extended_cost_text }}</td>
        <td class="sug-par-col">{{ line.suggested_par_level if line.suggested_par_level is not none else '-' }}</td>
        {% for split in line.store_allocations %}
        <td>
          <input
            type="number"
            min="0"
            step="1"
            name="alloc__{{ line.id }}__{{ split.store_id }}"
            value="{{ split.allocated_qty }}"
            title="{{ split.store_name }}"
            class="js-alloc store-col-input"
            data-line-id="{{ line.id }}"
          />
        </td>
        <td><input type="number" value="{{ split.on_hand_qty }}" readonly title="{{ split.store_name }} On Hand" class="store-col-input" /></td>
        {% endfor %}
      </tr>
      {% else %}
      <tr><td colspan="{{ 9 + (detail.store_columns|length * 2) }}">No low-confidence lines.</td></tr>
      {% endfor %}
    </tbody>
  </table>
  </div>

  <div class="actions">
    <button type="submit">Save Draft</button>
    <button
      type="submit"
      formaction="/management/ordering-tool/orders/{{ detail.order.id }}/submit"
      {% if detail.order.status.value != 'DRAFT' %}disabled{% endif %}
    >
      Submit (In Transit)
    </button>
  </div>
</form>
<script>
  (function () {
    function formatMoney(value) {
      return '$' + value.toFixed(2);
    }

    function lineUnitCost(lineId) {
      const row = document.querySelector('tr[data-line-id="' + lineId + '"]');
      if (!row) return null;
      const raw = (row.dataset.unitCost || '').trim();
      if (!raw) return null;
      const parsed = parseFloat(raw);
      if (Number.isNaN(parsed)) return null;
      return parsed;
    }

    function lineOrderQty(lineId) {
      const ro = document.querySelector('.js-order-qty[data-line-id="' + lineId + '"]');
      if (!ro) return 0;
      const parsed = parseInt(ro.value || '0', 10);
      if (Number.isNaN(parsed) || parsed < 0) return 0;
      return parsed;
    }

    function updateLineExtendedCost(lineId) {
      const extCell = document.querySelector('.js-ext-cost[data-line-id="' + lineId + '"]');
      if (!extCell) return;
      const unitCost = lineUnitCost(lineId);
      if (unitCost === null) {
        extCell.textContent = '-';
        return;
      }
      const extCost = unitCost * lineOrderQty(lineId);
      extCell.textContent = formatMoney(extCost);
    }

    function updateTotalExtendedCost() {
      let total = 0;
      document.querySelectorAll('tr[data-line-id]').forEach((row) => {
        const lineId = row.dataset.lineId;
        const unitCost = lineUnitCost(lineId);
        if (unitCost === null) return;
        total += unitCost * lineOrderQty(lineId);
      });
      const totalEl = document.getElementById('order-total-ext-cost');
      if (totalEl) totalEl.textContent = formatMoney(total);
    }

    function updateComputedOrderQty(lineId) {
      const inputs = document.querySelectorAll('.js-alloc[data-line-id="' + lineId + '"]');
      let total = 0;
      inputs.forEach((input) => {
        const v = parseInt(input.value || '0', 10);
        if (!Number.isNaN(v) && v > 0) total += v;
      });
      const ro = document.querySelector('.js-order-qty[data-line-id="' + lineId + '"]');
      if (ro) ro.value = String(total);
      updateLineExtendedCost(lineId);
      updateTotalExtendedCost();
    }

    document.querySelectorAll('.js-alloc').forEach((input) => {
      input.addEventListener('input', function () {
        updateComputedOrderQty(this.dataset.lineId);
      });
    });

    document.querySelectorAll('tr[data-line-id]').forEach((row) => {
      updateLineExtendedCost(row.dataset.lineId);
    });
    updateTotalExtendedCost();

    document.querySelectorAll('.js-sortable').forEach((table) => {
      const state = {};
      table.querySelectorAll('.js-sort').forEach((btn) => {
        btn.addEventListener('click', () => {
          const key = btn.dataset.key;
          const isNumber = btn.dataset.type === 'number';
          state[key] = state[key] === 'asc' ? 'desc' : 'asc';
          const dir = state[key] === 'asc' ? 1 : -1;
          const tbody = table.querySelector('tbody');
          const rows = Array.from(tbody.querySelectorAll('tr')).filter((r) => r.dataset[key] !== undefined);
          rows.sort((a, b) => {
            const av = a.dataset[key];
            const bv = b.dataset[key];
            if (isNumber) return (parseFloat(av) - parseFloat(bv)) * dir;
            return av.localeCompare(bv) * dir;
          });
          rows.forEach((row) => tbody.appendChild(row));
        });
      });
    });
  })();
</script>
{% endblock %}
