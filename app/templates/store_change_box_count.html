{% extends 'base.html' %}
{% block content %}
<h1>Change Box Count</h1>
{% if is_new_draft %}
<p class="muted">Created a new draft change box count.</p>
{% else %}
<p class="muted">Draft available.</p>
{% endif %}
<p class="muted">Store: {{ store_name }} | Draft ID: {{ count.id }}</p>

<form method="post" action="/store/change-box-count/{{ count.id }}/save" data-autosave="true" data-autosave-status-id="autosave-status-change-box">
  <input type="hidden" name="csrf_token" value="{{ csrf_token(request) }}" />
  <label><strong>Name</strong></label>
  <input type="text" name="employee_name" value="{{ count.employee_name }}" required />

  <table>
    <thead>
      <tr>
        <th>Denomination</th>
        <th>Unit Value</th>
        <th>Rolls</th>
        <th>Loose</th>
        <th>Total Units</th>
        <th>Line Amount</th>
      </tr>
    </thead>
    <tbody>
      {% for line in lines %}
      {% set roll_size = roll_sizes.get(line.denomination_code) %}
      {% if roll_size %}
      {% set default_rolls = (line.quantity // roll_size) %}
      {% set default_loose = (line.quantity % roll_size) %}
      {% else %}
      {% set default_rolls = 0 %}
      {% set default_loose = line.quantity %}
      {% endif %}
      <tr>
        <td>{{ line.denomination_label }}</td>
        <td class="unit-value" data-unit-value="{{ line.unit_value }}">${{ '%.2f'|format(line.unit_value) }}</td>
        <td>
          <input
            type="number"
            min="0"
            step="1"
            name="qty_rolls__{{ line.denomination_code }}"
            value="{{ default_rolls }}"
            data-role="rolls"
            data-roll-size="{{ roll_size or 0 }}"
            class="qty-input"
            {% if not roll_size %}readonly{% endif %}
            required
          />
        </td>
        <td>
          <input
            type="number"
            min="0"
            step="1"
            name="qty_loose__{{ line.denomination_code }}"
            value="{{ default_loose }}"
            data-role="loose"
            data-roll-size="{{ roll_size or 0 }}"
            data-unit-value="{{ line.unit_value }}"
            class="qty-input"
            required
          />
        </td>
        <td><span class="total-units">{{ line.quantity }}</span></td>
        <td>$<span class="line-amount">{{ '%.2f'|format(line.line_amount) }}</span></td>
      </tr>
      {% endfor %}
    </tbody>
  </table>

  <p><strong>Total: $<span id="change-box-total">{{ '%.2f'|format(count.total_amount) }}</span></strong></p>

  <div class="actions">
    <button type="submit">Save Draft</button>
    <button type="submit" formaction="/store/change-box-count/{{ count.id }}/submit">Submit Change Box Count</button>
  </div>
</form>
<p id="autosave-status-change-box" class="autosave-status">Autosave enabled.</p>

<script>
  (() => {
    const qtyInputs = Array.from(document.querySelectorAll('.qty-input'));
    const totalEl = document.getElementById('change-box-total');
    if (!qtyInputs.length || !totalEl) return;

    const toNumber = (value) => {
      const n = Number(value);
      return Number.isFinite(n) && n >= 0 ? n : 0;
    };

    const recalcRow = (input) => {
      const row = input.closest('tr');
      if (!row) return 0;
      const lineAmountEl = row.querySelector('.line-amount');
      const totalUnitsEl = row.querySelector('.total-units');
      if (!lineAmountEl || !totalUnitsEl) return 0;
      const rollsInput = row.querySelector('input[data-role=\"rolls\"]');
      const looseInput = row.querySelector('input[data-role=\"loose\"]');
      if (!looseInput) return 0;
      const rollSize = toNumber(looseInput.dataset.rollSize);
      const rolls = rollsInput ? toNumber(rollsInput.value) : 0;
      const loose = toNumber(looseInput.value);
      const qty = rollSize > 0 ? (rolls * rollSize) + loose : loose;
      const unitValue = toNumber(looseInput.dataset.unitValue);
      const lineAmount = qty * unitValue;
      totalUnitsEl.textContent = String(qty);
      lineAmountEl.textContent = lineAmount.toFixed(2);
      return lineAmount;
    };

    const recalcTotal = () => {
      let total = 0;
      qtyInputs.forEach((input) => {
        total += recalcRow(input);
      });
      totalEl.textContent = total.toFixed(2);
    };

    qtyInputs.forEach((input) => {
      input.addEventListener('change', recalcTotal);
      input.addEventListener('blur', recalcTotal);
      input.addEventListener('input', recalcTotal);
      input.addEventListener('keydown', (event) => {
        if (event.key === 'Enter' || event.key === 'Tab') {
          recalcTotal();
        }
      });
    });

    recalcTotal();
  })();
</script>
{% endblock %}
