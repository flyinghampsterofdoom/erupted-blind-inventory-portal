{% extends 'base.html' %}
{% block content %}
<h1>Master Safe Audit</h1>
<p class="muted">Admin-only master safe audit and balance update.</p>

<form method="post" action="/management/master-safe-audit/submit">
  <input type="hidden" name="csrf_token" value="{{ csrf_token(request) }}" />

  <label><strong>Auditor Name</strong></label>
  <input type="text" name="auditor_name" required />

  <label><strong>Target Master Safe Value</strong></label>
  <input type="number" min="0" step="0.01" name="target_amount" value="{{ inventory.target_amount }}" required />

  <table>
    <thead>
      <tr>
        <th>Denomination</th>
        <th>Unit Value</th>
        <th>Rolls</th>
        <th>Loose</th>
        <th>Total Units</th>
        <th>Amount</th>
      </tr>
    </thead>
    <tbody>
      {% for line in inventory.lines %}
      {% set roll_size = roll_sizes.get(line.denomination_code) %}
      {% if roll_size %}
      {% set default_rolls = (line.quantity // roll_size) %}
      {% set default_loose = (line.quantity % roll_size) %}
      {% else %}
      {% set default_rolls = 0 %}
      {% set default_loose = line.quantity %}
      {% endif %}
      <tr>
        <td>{{ line.denomination_label }}</td>
        <td>${{ '%.2f'|format(line.unit_value) }}</td>
        <td>
          <input
            type="number"
            min="0"
            step="1"
            name="qty_rolls__{{ line.denomination_code }}"
            value="{{ default_rolls }}"
            data-role="rolls"
            data-roll-size="{{ roll_size or 0 }}"
            class="master-safe-qty-input"
            {% if not roll_size %}readonly{% endif %}
            required
          />
        </td>
        <td>
          <input
            type="number"
            min="0"
            step="1"
            name="qty_loose__{{ line.denomination_code }}"
            value="{{ default_loose }}"
            data-role="loose"
            data-roll-size="{{ roll_size or 0 }}"
            data-unit-value="{{ line.unit_value }}"
            class="master-safe-qty-input"
            required
          />
        </td>
        <td><span class="master-safe-total-units">{{ line.quantity }}</span></td>
        <td>$<span class="master-safe-line-amount">{{ '%.2f'|format(line.line_amount) }}</span></td>
      </tr>
      {% endfor %}
    </tbody>
  </table>

  <p><strong>Current Computed Total: $<span id="master-safe-computed-total">{{ '%.2f'|format(inventory.total_amount) }}</span></strong></p>
  <div class="actions">
    <button type="submit">Submit Master Safe Audit</button>
  </div>
</form>

<script>
  (() => {
    const inputs = Array.from(document.querySelectorAll('.master-safe-qty-input'));
    const totalEl = document.getElementById('master-safe-computed-total');
    if (!inputs.length || !totalEl) return;
    const rows = Array.from(document.querySelectorAll('table tbody tr'));

    const toNumber = (v) => {
      const n = Number(v);
      return Number.isFinite(n) && n >= 0 ? n : 0;
    };

    const recalc = () => {
      let total = 0;
      rows.forEach((row) => {
        const lineAmountEl = row.querySelector('.master-safe-line-amount');
        const totalUnitsEl = row.querySelector('.master-safe-total-units');
        const rollsInput = row.querySelector('input[data-role="rolls"]');
        const looseInput = row.querySelector('input[data-role="loose"]');
        if (!lineAmountEl || !totalUnitsEl || !looseInput) return;
        const rollSize = toNumber(looseInput.dataset.rollSize);
        const rolls = rollsInput ? toNumber(rollsInput.value) : 0;
        const loose = toNumber(looseInput.value);
        const qty = rollSize > 0 ? (rolls * rollSize) + loose : loose;
        const unit = toNumber(looseInput.dataset.unitValue);
        const lineAmount = qty * unit;
        totalUnitsEl.textContent = String(qty);
        lineAmountEl.textContent = lineAmount.toFixed(2);
        total += lineAmount;
      });
      totalEl.textContent = total.toFixed(2);
    };

    inputs.forEach((input) => {
      input.addEventListener('input', recalc);
      input.addEventListener('change', recalc);
      input.addEventListener('blur', recalc);
      input.addEventListener('keydown', (event) => {
        if (event.key === 'Enter' || event.key === 'Tab') recalc();
      });
    });

    recalc();
  })();
</script>
{% endblock %}
