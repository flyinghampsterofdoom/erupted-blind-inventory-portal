{% extends 'base.html' %}
{% block content %}
<h1>Par/Level - {{ detail.vendor.name }}</h1>
<p class="muted">Level triggers reorder. Par is the target quantity to order up to when on-hand is at/below level.</p>
<p><a href="/management/ordering-tool/par-levels">Back to Par/Level Vendors</a></p>

{% if query.get('saved') %}
<p class="muted">Saved {{ query.get('saved') }} row(s).</p>
{% endif %}

<form method="get" action="/management/ordering-tool/par-levels/{{ detail.vendor.id }}" style="display:flex; gap:8px; align-items:end; flex-wrap:wrap;">
  <div>
    <label>History Lookback Days</label>
    <input type="number" min="7" step="1" name="history_lookback_days" value="{{ history_lookback_days }}" required />
  </div>
  <button type="submit">Recompute Living Values</button>
</form>

<form method="post" action="/management/ordering-tool/par-levels/{{ detail.vendor.id }}/save">
  <input type="hidden" name="csrf_token" value="{{ csrf_token(request) }}" />
  <input type="hidden" name="history_lookback_days" value="{{ history_lookback_days }}" />

  <div class="actions">
    <button type="submit">Save Manual Par/Level</button>
  </div>

  <style>
    .par-matrix input[type="number"] { width: 64px; max-width: 64px; }
    .par-matrix th,
    .par-matrix td { white-space: nowrap; }
  </style>
  <div style="overflow-x:auto; max-width:100%; border:1px solid #e5e7eb; border-radius:8px;">
    <table class="par-matrix">
      <thead>
        <tr>
          <th>SKU</th>
          <th>Item</th>
          <th>Var.</th>
          {% for store in detail['stores'] %}
          <th title="{{ store.name }} Level">{{ store.label }}/L</th>
          <th title="{{ store.name }} Par">{{ store.label }}/P</th>
          {% endfor %}
        </tr>
      </thead>
      <tbody>
        {% for item in detail['items'] %}
        <tr {% if item.needs_manual %}style="background:#fff7ed;"{% endif %}>
          <td>{{ item.sku }}</td>
          <td>{{ item.item_name }}</td>
          <td>{{ item.variation_name }}</td>
          {% for cell in item.store_cells %}
          <td title="OH {{ cell.on_hand_qty }} | Live {{ cell.suggested_level }}/{{ cell.suggested_par }} | Eff {{ cell.effective_level }}/{{ cell.effective_par }} | {{ cell.confidence_state }} {{ cell.confidence_score }}">
            <input type="hidden" name="row_key" value="{{ cell.row_key }}" />
            <input type="number" min="0" step="1" name="manual_level__{{ cell.row_key }}" value="{{ cell.manual_level if cell.manual_level is not none else '' }}" />
          </td>
          <td title="OH {{ cell.on_hand_qty }} | Live {{ cell.suggested_level }}/{{ cell.suggested_par }} | Eff {{ cell.effective_level }}/{{ cell.effective_par }} | {{ cell.confidence_state }} {{ cell.confidence_score }}">
            <input type="number" min="0" step="1" name="manual_par__{{ cell.row_key }}" value="{{ cell.manual_par if cell.manual_par is not none else '' }}" />
          </td>
          {% endfor %}
        </tr>
        {% else %}
        <tr><td colspan="{{ 3 + (detail['stores']|length * 2) }}">No active vendor SKUs found.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <div class="actions">
    <button type="submit">Save Manual Par/Level</button>
  </div>
</form>
{% endblock %}
