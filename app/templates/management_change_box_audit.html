{% extends 'base.html' %}
{% block content %}
<h1>Change Box Audit</h1>
<p class="muted">Set target value and verify/update current denomination quantities.</p>

<form method="get" action="/management/change-box-audit" style="display:flex; gap:10px; align-items:end; margin-bottom:12px;">
  <div>
    <label>Location</label>
    <select name="store_id">
      {% for store in stores %}
      <option value="{{ store.id }}" {% if selected_store_id == store.id %}selected{% endif %}>{{ store.name }}</option>
      {% endfor %}
    </select>
  </div>
  <button type="submit">Load</button>
</form>

{% if selected_store_id %}
<form method="post" action="/management/change-box-audit/{{ selected_store_id }}/submit">
  <input type="hidden" name="csrf_token" value="{{ csrf_token(request) }}" />
  <label><strong>Auditor Name</strong></label>
  <input type="text" name="auditor_name" required />

  <label><strong>Target Change Box Value</strong></label>
  <input type="number" min="0" step="0.01" name="target_amount" value="{{ inventory.target_amount }}" required />

  <table>
    <thead>
      <tr>
        <th>Denomination</th>
        <th>Unit Value</th>
        <th>Rolls</th>
        <th>Loose</th>
        <th>Total Units</th>
        <th>Amount</th>
      </tr>
    </thead>
    <tbody>
      {% for line in inventory.lines %}
      {% set roll_size = roll_sizes.get(line.denomination_code) %}
      {% if roll_size %}
      {% set default_rolls = (line.quantity // roll_size) %}
      {% set default_loose = (line.quantity % roll_size) %}
      {% else %}
      {% set default_rolls = 0 %}
      {% set default_loose = line.quantity %}
      {% endif %}
      <tr>
        <td>{{ line.denomination_label }}</td>
        <td class="unit-value">${{ '%.2f'|format(line.unit_value) }}</td>
        <td>
          <input
            type="number"
            min="0"
            step="1"
            name="qty_rolls__{{ line.denomination_code }}"
            value="{{ default_rolls }}"
            data-role="rolls"
            data-roll-size="{{ roll_size or 0 }}"
            class="audit-qty-input"
            {% if not roll_size %}readonly{% endif %}
            required
          />
        </td>
        <td>
          <input
            type="number"
            min="0"
            step="1"
            name="qty_loose__{{ line.denomination_code }}"
            value="{{ default_loose }}"
            data-unit-value="{{ line.unit_value }}"
            data-role="loose"
            data-roll-size="{{ roll_size or 0 }}"
            class="audit-qty-input"
            required
          />
        </td>
        <td><span class="audit-total-units">{{ line.quantity }}</span></td>
        <td>$<span class="audit-line-amount">{{ '%.2f'|format(line.line_amount) }}</span></td>
      </tr>
      {% endfor %}
    </tbody>
  </table>

  <p><strong>Current Computed Total: $<span id="audit-computed-total">{{ '%.2f'|format(inventory.total_amount) }}</span></strong></p>
  <div class="actions">
    <button type="submit">Submit Audit + Update Change Box State</button>
  </div>
</form>
{% endif %}

<script>
  (() => {
    const inputs = Array.from(document.querySelectorAll('.audit-qty-input'));
    const totalEl = document.getElementById('audit-computed-total');
    if (!inputs.length || !totalEl) return;
    const rows = Array.from(document.querySelectorAll('table tbody tr'));

    const toNumber = (v) => {
      const n = Number(v);
      return Number.isFinite(n) && n >= 0 ? n : 0;
    };

    const recalc = () => {
      let total = 0;
      rows.forEach((row) => {
        const lineAmountEl = row ? row.querySelector('.audit-line-amount') : null;
        const totalUnitsEl = row ? row.querySelector('.audit-total-units') : null;
        const rollsInput = row ? row.querySelector('input[data-role="rolls"]') : null;
        const looseInput = row ? row.querySelector('input[data-role="loose"]') : null;
        if (!lineAmountEl || !totalUnitsEl || !looseInput) return;
        const rollSize = toNumber(looseInput.dataset.rollSize);
        const rolls = rollsInput ? toNumber(rollsInput.value) : 0;
        const loose = toNumber(looseInput.value);
        const qty = rollSize > 0 ? (rolls * rollSize) + loose : loose;
        const unit = toNumber(looseInput.dataset.unitValue);
        const lineAmount = qty * unit;
        totalUnitsEl.textContent = String(qty);
        if (lineAmountEl) lineAmountEl.textContent = lineAmount.toFixed(2);
        total += lineAmount;
      });
      totalEl.textContent = total.toFixed(2);
    };

    inputs.forEach((input) => {
      input.addEventListener('input', recalc);
      input.addEventListener('change', recalc);
      input.addEventListener('blur', recalc);
      input.addEventListener('keydown', (event) => {
        if (event.key === 'Enter' || event.key === 'Tab') recalc();
      });
    });

    recalc();
  })();
</script>
{% endblock %}
