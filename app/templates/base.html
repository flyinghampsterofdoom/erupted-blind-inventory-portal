<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>{{ title or 'Blind Inventory Portal' }}</title>
    <style>
      body { font-family: ui-sans-serif, system-ui, -apple-system, sans-serif; margin: 24px; }
      table { border-collapse: collapse; width: 100%; margin-top: 16px; }
      th, td { border: 1px solid #d1d5db; padding: 8px; text-align: left; }
      .actions { margin: 16px 0; display: flex; gap: 8px; }
      .muted { color: #6b7280; }
      .error { color: #b91c1c; }
      input[type='text'], input[type='number'], input[type='password'] { padding: 6px; width: 100%; max-width: 320px; }
      textarea, select { padding: 6px; width: 100%; max-width: 480px; }
      .topnav { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; }
      .topnav a { margin-right: 10px; }
      .menu-links { display: inline-flex; gap: 10px; flex-wrap: wrap; }
      .autosave-status { color: #6b7280; font-size: 0.9rem; margin-top: 6px; }
    </style>
  </head>
  <body>
    {% set principal = request.state.principal if request and request.state else None %}
    <div class="topnav">
      <div>
        <a href="/">Home</a>
        {% if principal and principal.role != 'STORE' %}
        <span class="menu-links">
          <a href="/management/home">Dashboard</a>
          <a href="/management/sessions">Counts</a>
          {% if principal.role in ['ADMIN', 'MANAGER'] %}
          <a href="/management/groups">Manage Groups</a>
          <a href="/management/users">Users</a>
          {% endif %}
        </span>
        {% endif %}
      </div>
      <form method="post" action="/logout">
        <input type="hidden" name="csrf_token" value="{{ csrf_token(request) }}" />
        <button type="submit">Logout</button>
      </form>
    </div>
    {% block content %}{% endblock %}
    <script>
      (() => {
        const AUTO_SAVE_INTERVAL_MS = 30000;
        const forms = Array.from(document.querySelectorAll('form[data-autosave="true"]'));
        if (!forms.length) return;
        const autosaveControllers = [];

        const nowTime = () => new Date().toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' });

        forms.forEach((form) => {
          const statusTargetId = form.dataset.autosaveStatusId;
          const statusEl = statusTargetId ? document.getElementById(statusTargetId) : null;
          let dirty = false;
          let inFlight = false;
          let lastSerialized = '';

          const serializeForm = () => {
            const fd = new FormData(form);
            const entries = [];
            for (const [k, v] of fd.entries()) {
              entries.push(`${k}=${String(v)}`);
            }
            entries.sort();
            return entries.join('&');
          };

          const markDirty = () => {
            dirty = true;
            if (statusEl) statusEl.textContent = 'Unsaved changes';
          };

          const tryAutoSave = async () => {
            if (inFlight) return;
            if (!dirty) return;
            const action = form.getAttribute('action');
            if (!action) return;

            const snapshot = serializeForm();
            if (snapshot === lastSerialized) {
              dirty = false;
              return;
            }

            inFlight = true;
            try {
              const fd = new FormData(form);
              const response = await fetch(action, {
                method: 'POST',
                body: fd,
                credentials: 'same-origin',
                headers: { 'X-Requested-With': 'autosave' },
              });
              const redirectedToLogin = response.redirected && response.url.includes('/login');
              if (response.status === 401 || redirectedToLogin) {
                if (statusEl) statusEl.textContent = 'Session expired. Log in again to keep saving.';
              } else if (response.ok) {
                lastSerialized = snapshot;
                dirty = false;
                if (statusEl) statusEl.textContent = `Draft autosaved at ${nowTime()}`;
              } else if (statusEl) {
                statusEl.textContent = 'Autosave failed, changes kept locally in form';
              }
            } catch (_err) {
              if (statusEl) statusEl.textContent = 'Autosave failed, will retry';
            } finally {
              inFlight = false;
            }
          };

          form.addEventListener('input', markDirty);
          form.addEventListener('change', markDirty);
          form.addEventListener('submit', () => {
            dirty = false;
          });

          setInterval(() => {
            void tryAutoSave();
          }, AUTO_SAVE_INTERVAL_MS);

          document.addEventListener('visibilitychange', () => {
            if (document.visibilityState === 'hidden') {
              void tryAutoSave();
            }
          });

          window.addEventListener('pagehide', () => {
            if (!dirty || inFlight) return;
            const action = form.getAttribute('action');
            if (!action) return;
            try {
              const payload = new URLSearchParams(new FormData(form));
              navigator.sendBeacon(action, payload);
            } catch (_err) {
              // Ignore best-effort save failures during page unload.
            }
          });

          autosaveControllers.push({
            isDirty: () => dirty,
            tryAutoSave,
          });
        });

        const logoutForm = document.querySelector('form[action="/logout"]');
        if (logoutForm) {
          logoutForm.addEventListener('submit', async (event) => {
            const dirtyControllers = autosaveControllers.filter((controller) => controller.isDirty());
            if (!dirtyControllers.length) return;
            event.preventDefault();
            await Promise.all(dirtyControllers.map((controller) => controller.tryAutoSave()));
            logoutForm.submit();
          });
        }
      })();
    </script>
  </body>
</html>
